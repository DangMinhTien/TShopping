@model IEnumerable<TShopping.ViewModels.CartItem>
@{
    ViewData["Title"] = "Checkout";
    var checkoutVm = new TShopping.ViewModels.CheckoutVM();
}
<!-- Single Page Header start -->
<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">Thanh toán</h1>
    <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="#">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="#">Hàng hóa</a></li>
        <li class="breadcrumb-item active text-white">Thanh toán</li>
    </ol>
</div>
<!-- Single Page Header End -->
<!-- Checkout Page Start -->
<div class="container-fluid py-5">
    <div class="container py-5">
        <h1 class="mb-4">Billing details</h1>
        <div class="row g-5">
            <div class="col-md-12 col-lg-6 col-xl-7">
                <form method="post" asp-action="Checkout" asp-controller="Cart">
                    <div id="errMes" class="text-danger" asp-validation-summary="All"></div>
                    <div class="form-item">
                        <label class="form-label my-3">Họ tên</label>
                        <input type="text" id="HoTen" name="HoTen" class="form-control">
                    </div>
                    <div class="form-item">
                        <label class="form-label my-3">Địa chỉ</label><sup>*</sup>
                        <input type="text" id="DiaChi" name="DiaChi" class="form-control">
                    </div>
                    <div class="form-item">
                        <label class="form-label my-3">Điện thoại</label><sup>*</sup>
                        <input type="text" id="DienThoai" name="DienThoai" class="form-control">
                    </div>
                    <div class="form-check my-3">
                        <input type="checkbox" class="form-check-input" name="GiongVM" value="true">
                        <label class="form-check-label" for="Account-1">Create an account?</label>
                    </div>
                    <div class="form-item">
                        <textarea id="GhiChu" name="GhiChu" class="form-control" spellcheck="false" cols="30" rows="11" placeholder="Ghi chú cho chúng tôi"></textarea>
                    </div>
                    <div class="row g-4 text-center align-items-center justify-content-center pt-4">
                        <input asp-route-payment="@TShopping.Helpers.PaymentType.COD" value="Thanh toán (COD)" 
                            type="submit" class="btn border-secondary py-3 px-4 text-uppercase w-100 text-primary" />
                        @* thanh toán Paypal *@
                        <div id="paypal-button-container" style="max-width:1000px;"></div>
                        @* thanh toán VnPay *@
                        <input asp-route-payment="@TShopping.Helpers.PaymentType.VnPay" value="Thanh toán VnPay" 
                            type="submit" class="btn border-secondary py-3 px-4 text-uppercase w-100 text-primary" />
                    </div>
                </form>
            </div>
            <div class="col-md-12 col-lg-6 col-xl-5">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Hình ảnh</th>
                                <th scope="col">Tên</th>
                                <th scope="col">Đơn giá</th>
                                <th scope="col">Số lượng</th>
                                <th scope="col">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach(var item in Model)
                            {
                                <tr>
                                    <th scope="row">
                                        <div class="d-flex align-items-center mt-2">
                                            <img src="~/Hinh/HangHoa/@item.Hinh" class="img-fluid rounded-circle" style="width: 90px; height: 90px;" alt="">
                                        </div>
                                    </th>
                                    <td class="py-5">@item.TenHh</td>
                                    <td class="py-5">@string.Format("{0:N0}", item.DonGia)đ</td>
                                    <td class="py-5">@item.SoLuong</td>
                                    <td class="py-5">@string.Format("{0:N0}", item.ThanhTien)đ</td>
                                </tr>
                            }

                            <tr>
                                <th scope="row">
                                </th>
                                <td class="py-5"></td>
                                <td class="py-5"></td>
                                <td class="py-5">
                                    <p class="mb-0 text-dark py-3">Thành tiền</p>
                                </td>
                                <td class="py-5">
                                    <div class="py-3 border-bottom border-top">
                                        <p class="mb-0 text-dark">@string.Format("{0:N0}", Model.Sum(c => c.ThanhTien))đ</p>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">
                                </th>
                                <td class="py-5">
                                    <p class="mb-0 text-dark text-uppercase py-3">Tổng tiền</p>
                                </td>
                                <td class="py-5"></td>
                                <td class="py-5"></td>
                                <td class="py-5">
                                    <div class="py-3 border-bottom border-top">
                                        <p class="mb-0 text-dark">@string.Format("{0:N0}", Model.Sum(c => c.ThanhTien))đ</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Checkout Page End -->
@section Scripts {
    <script src="https://www.paypal.com/sdk/js?client-id=@ViewBag.PaypalClientId"></script>
    <script type="text/javascript">
        paypal.Buttons({
          style: {
            disableMaxWidth: true,
            color: "silver",
            layout: "vertical"
          },
            createOrder() {
                var check = true
                var error = ''
                if ($('#DienThoai').val().trim() == '') {
                    error += '<p>Điện thoại không được để trống</p>'
                    check = false
                }
                if ($('#DienThoai').val().trim() != '') {
                    var phonePatern = /^0\d{9}$/
                    if (!phonePatern.test($('#DienThoai').val())) {
                        error += '<p>Điện thoại koong đúng định dạng</p>'
                        check = false
                    }

                }
                if ($('#DiaChi').val().trim() == '') {
                    error += '<p>Địa chỉ không được để trống</p>'
                    check = false
                }
                console.log(check)
                if (check == false) {
                    $('#errMes').html(error)
                    return
                }
                $('#errMes').html('')
                return fetch("/Cart/create-paypal-order", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    }
                }).then(function (response) {
                    if(!response.ok){
                        return response.json().then((err) => {
                            throw err;
                        })
                    }
                    return response.json()
                })
                .then((order) => order.id)
                .catch((err) => {
                    alert(err.message)
                })
                // This function sets up the details of the transaction, including the amount and line item details.
            },
            onApprove(data) {
                let dataToSend = {
                    HoTen: $("#HoTen").val(),
                    DiaChi: $("#DiaChi").val(),
                    DienThoai: $("#DienThoai").val(),
                    CachThanhToan: 'Paypal',
                    GhiChu: $('#GhiChu').val()
                }
                console.log(dataToSend)
                // This function captures the funds from the transaction.
                return fetch(`/Cart/capture-paypal-order?orderId=${data.orderID}`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                    },
                    body: JSON.stringify(dataToSend)
                })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((err) => {
                            throw err;
                        })
                    }
                    
                    window.location.href = "/Cart/OrderSuccess"
                })
                .catch((err) => {
                    console.log(err.error)
                    window.location.href = "/Cart/OrderFail"
                });
            }
        }).render('#paypal-button-container');
    </script>
}
